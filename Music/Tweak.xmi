#import "Tweak.h"
#import "../MSHUtils.h"
#import <arpa/inet.h>

UIColor * colorWithMinimumSaturation(UIColor *self, double saturation){
    if (!self)
        return nil;
    
    CGFloat h, s, b, a;
    [self getHue:&h saturation:&s brightness:&b alpha:&a];
    
    if (s < saturation)
        return [UIColor colorWithHue:h saturation:saturation brightness:b alpha:a];
    
    return self;
}

UIColor * averageColor(UIImage *image, double alpha){
    //Work within the RGB colorspoace
    CGColorSpaceRef colorSpace = CGColorSpaceCreateDeviceRGB();
    unsigned char rgba[4];
    CGContextRef context = CGBitmapContextCreate(rgba, 1, 1, 8, 4, colorSpace, kCGImageAlphaPremultipliedLast | kCGBitmapByteOrder32Big);
    
    //Draw our image down to 1x1 pixels
    CGContextDrawImage(context, CGRectMake(0, 0, 1, 1), image.CGImage);
    CGColorSpaceRelease(colorSpace);
    CGContextRelease(context);
    
    //Check if image alpha is 0
    if (rgba[3] == 0) {
        CGFloat imageAlpha = ((CGFloat)rgba[3])/255.0;
        CGFloat multiplier = imageAlpha/255.0;
        UIColor *averageColor = [UIColor colorWithRed:((CGFloat)rgba[0])*multiplier green:((CGFloat)rgba[1])*multiplier blue:((CGFloat)rgba[2])*multiplier alpha:imageAlpha];
        
        //Improve color
        averageColor = colorWithMinimumSaturation(averageColor, 0.15);
        
        //Return average color
        return averageColor;
    } else {
        //Get average
        UIColor *averageColor = [UIColor colorWithRed:((CGFloat)rgba[0])/255.0 green:((CGFloat)rgba[1])/255.0 blue:((CGFloat)rgba[2])/255.0 alpha:alpha];
        
        //Improve color
        averageColor = colorWithMinimumSaturation(averageColor, 0.15);
        
        //Return average color
        return averageColor;
    }
}

%group MitsuhaVisuals

%hook MusicNowPlayingControlsViewController

int connfd = -1;

-(void)viewDidLoad{
    %orig;

    struct sockaddr_in remote;
    remote.sin_family = AF_INET;
    remote.sin_port = htons(MSHPort);
    inet_aton("127.0.0.1", &remote.sin_addr);
    connfd = socket(AF_INET, SOCK_STREAM, 0);

    int r = -1;
    while(r != 0) {
        r = connect(connfd, (struct sockaddr *)&remote, sizeof(remote));
    }
    
    self.displayLink = [CADisplayLink displayLinkWithTarget:self selector:@selector(updateFrame:)];
    self.displayLink.preferredFramesPerSecond = 60;
    
    MSHJelloViewConfig *config = [MSHJelloViewConfig loadConfigForApplication:@"Music"];
    if (!config.enabled) return;
    
    config.waveOffset += 70;
    CGFloat height = CGRectGetHeight(self.view.bounds);
    self.view.clipsToBounds = 1;
    
    self.mitsuhaJelloView = [[MSHJelloView alloc] initWithFrame:CGRectMake(0, 0, self.view.bounds.size.width, height) andConfig:config];
    
    [self.view addSubview:self.mitsuhaJelloView];
    [self.view sendSubviewToBack:self.mitsuhaJelloView];
}

-(void)viewWillAppear:(BOOL)animated{
    %orig;
    self.mitsuhaJelloView.center = CGPointMake(self.mitsuhaJelloView.center.x, self.mitsuhaJelloView.frame.size.height + self.mitsuhaJelloView.config.waveOffset);
}

-(void)viewDidAppear:(BOOL)animated{
    %orig;
    [self.displayLink addToRunLoop:[NSRunLoop currentRunLoop] forMode:NSDefaultRunLoopMode];
    [self.displayLink setPaused:false];
}

-(void)viewWillDisappear:(BOOL)animated{
    %orig;
    [self.displayLink setPaused:YES];
    [self.displayLink removeFromRunLoop:[NSRunLoop currentRunLoop] forMode:NSDefaultRunLoopMode];
}

- (void)dealloc{
    close(connfd);
}

%new
-(void)updateFrame:(CADisplayLink *)dlink{
    UInt32 len = 0;
    send(connfd, &len, sizeof(UInt32), 0);
    recv(connfd, &len, sizeof(UInt32), 0);
    if (len > 0) {
        float * data = (float *)malloc(len);
        recv(connfd, data, len, 0);
        [self.mitsuhaJelloView updateBuffer:data withLength:len/sizeof(float) mul:4.0f];
    }
}

%new
-(void)setMitsuhaJelloView:(MSHJelloView *)mitsuhaJelloView{
    objc_setAssociatedObject(self, @selector(mitsuhaJelloView), mitsuhaJelloView, OBJC_ASSOCIATION_RETAIN_NONATOMIC);
}

%new
-(MSHJelloView *)mitsuhaJelloView{
    return objc_getAssociatedObject(self, @selector(mitsuhaJelloView));
}

%new
-(void)setDisplayLink:(CADisplayLink *)displayLink{
    objc_setAssociatedObject(self, @selector(displayLink), displayLink, OBJC_ASSOCIATION_RETAIN_NONATOMIC);
}

%new
-(CADisplayLink *)displayLink{
    return objc_getAssociatedObject(self, @selector(displayLink));
}

%end

%end

%ctor{
    %init(MitsuhaVisuals);
}
